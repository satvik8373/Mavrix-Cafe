<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Staff Dashboard - Mavrix Cafe</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root { --primary:#2196f3; --bg:#f5f7fb; --card:#fff; --text:#263238; --muted:#607d8b; --radius:14px; }
        *{ box-sizing: border-box }
        body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text) }
        .container{ max-width:1100px; margin:0 auto; padding:16px }
        .card{ background:var(--card); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.06); padding:18px }
        .login{ height:100vh; display:grid; place-items:center }
        .title{ display:flex; align-items:center; gap:10px; margin-bottom:12px }
        .title h1{ font-size:20px; margin:0 }
        .field{ margin:10px 0 }
        label{ display:block; font-weight:600; margin-bottom:6px; font-size:14px }
        input{ width:100%; padding:12px 14px; border:1px solid #e0e6ef; border-radius:10px; outline:0 }
        input:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(33,150,243,.12) }
        .btn{ background:var(--primary); border:0; color:#fff; padding:12px 16px; border-radius:10px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px }
        .row{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center }
        .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:12px 0 }
        .orders{ overflow:auto }
        .orders-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .order-card{ background:#fff; border-radius: 12px; box-shadow:0 4px 6px rgba(0,0,0,.08); overflow:hidden; border-left:4px solid #ffcc00 }
        .order-card.completed{ border-left-color:#2ecc71 }
        .order-header{ padding: 12px 14px; background:#f7f9fc; display:flex; align-items:center; justify-content:space-between }
        .order-title{ display:flex; flex-direction:column; gap:4px }
        .order-time{ color:#607d8b; font-size:12px }
        .status-badge{ padding:6px 10px; border-radius:999px; font-size:12px; background:#eceff1; color:#37474f; text-transform:capitalize }
        .status-badge.pending{ background:#fff3cd; color:#8a6d3b }
        .status-badge.completed{ background:#d4edda; color:#155724 }
        .order-content{ padding:14px }
        .order-customer{ display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:8px; margin-bottom:10px }
        .info-group{ display:flex; align-items:center; gap:8px; color:#607d8b }
        .order-items{ background:#f7f9fc; border-radius:10px; padding:10px; margin-top:8px }
        .order-item{ display:grid; grid-template-columns: 1fr auto auto; gap:8px; padding:6px 0; border-bottom:1px solid #eceff1 }
        .order-item:last-child{ border-bottom:none }
        .item-price{ color:#2196f3; font-weight:600 }
        .order-total{ display:flex; align-items:center; justify-content:space-between; padding-top:10px; margin-top:6px; border-top:2px solid #fff }
        .pill{ padding:4px 10px; border-radius:999px; font-size:12px; background:#eceff1; color:#37474f; display:inline-block }
        .pill.pending{ background:#fff3cd; color:#8a6d3b }
        .pill.completed{ background:#d4edda; color:#155724 }
        .toast{ position:fixed; top:16px; right:16px; background:#e74c3c; color:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.12) }
        .toast.ok{ background:#2ecc71 }
        .hidden{ display:none }
    </style>
</head>
<body>
    <div id="loginView" class="login">
        <div class="card" style="width:100%; max-width:420px;">
            <div class="title"><i class="fas fa-id-badge" style="color:var(--primary);"></i><h1>Staff Login</h1></div>
            <div class="field">
                <label for="username">Username</label>
                <input id="username" placeholder="staff username" autocomplete="username" />
            </div>
            <div class="field">
                <label for="password">Password</label>
                <input id="password" type="password" placeholder="password" autocomplete="current-password" />
            </div>
            <button id="loginBtn" class="btn"><i class="fas fa-sign-in-alt"></i> Login</button>
        </div>
    </div>

    <div id="appView" class="container hidden">
        <div class="toolbar">
            <div class="title"><i class="fas fa-mug-hot" style="color:var(--primary);"></i><h1>Staff Orders</h1></div>
            <div style="display:flex; gap:8px; align-items:center;">
                <button id="refreshBtn" class="btn" title="Refresh"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button id="logoutBtn" class="btn" style="background:#eceff1; color:#37474f"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
        <div class="card orders">
            <div id="ordersGrid" class="orders-grid"></div>
        </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script src="config.js"></script>
    <script>
        const API_BASE_URL = window.API_CONFIG ? window.API_CONFIG.API_URL : 'http://localhost:5000/api';
        const toast = document.getElementById('toast');
        const loginView = document.getElementById('loginView');
        const appView = document.getElementById('appView');
        const ordersGrid = document.getElementById('ordersGrid');

        function showToast(msg, ok=false){
            toast.textContent = msg; toast.className = `toast ${ok?'ok':''}`; toast.classList.remove('hidden');
            setTimeout(()=>toast.classList.add('hidden'), 2200);
        }

        function authed(){ return !!sessionStorage.getItem('staffToken'); }

        function setAuthed(token, user){
            sessionStorage.setItem('staffToken', token);
            sessionStorage.setItem('staffUser', JSON.stringify(user||{}));
        }

        function clearAuth(){
            sessionStorage.removeItem('staffToken');
            sessionStorage.removeItem('staffUser');
        }

        function updateView(){
            if (authed()) { loginView.classList.add('hidden'); appView.classList.remove('hidden'); loadOrders(); }
            else { appView.classList.add('hidden'); loginView.classList.remove('hidden'); }
        }

        async function staffLogin(){
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!username || !password) return showToast('Enter username and password');
            try{
                const res = await fetch(`${API_BASE_URL}/auth/staff/login`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username,password})
                });
                const data = await res.json();
                if(!res.ok) throw new Error(data.error||'Login failed');
                setAuthed(data.token, data.user);
                showToast('Login successful', true);
                updateView();
            }catch(e){ showToast(e.message||'Login failed'); }
        }

        async function loadOrders(){
            try{
                ordersGrid.innerHTML = '<div>Loading...</div>';
                const token = sessionStorage.getItem('staffToken') || '';
                const res = await fetch(`${API_BASE_URL}/staff/orders`, { headers: { 'Authorization': `Bearer ${token}` } });
                const orders = await res.json();
                if(!res.ok) throw new Error(orders.error||'Failed to load orders');
                if(!Array.isArray(orders) || orders.length===0){ ordersGrid.innerHTML = '<div class="no-orders">No orders</div>'; return; }
                ordersGrid.innerHTML = orders.map(o => {
                    const time = o.timestamp ? new Date(o.timestamp).toLocaleString() : '-';
                    const items = (o.items||[]).map(it => `
                        <div class="order-item">
                            <span>${(it.name||'').replace(/</g,'&lt;')}</span>
                            <span>×${it.quantity||0}</span>
                            <span class="item-price">₹${Number((it.price||0)*(it.quantity||0)).toFixed(2)}</span>
                        </div>
                    `).join('');
                    return `
                    <div class="order-card ${o.status}">
                        <div class="order-header">
                            <div class="order-title">
                                <strong>Order #${(o._id||'').slice(-6).toUpperCase()}</strong>
                                <span class="order-time">${time}</span>
                            </div>
                            <span class="status-badge ${o.status}">${o.status}</span>
                        </div>
                        <div class="order-content">
                            <div class="order-customer">
                                <div class="info-group"><i class="fas fa-user"></i>${(o.customerName||'').replace(/</g,'&lt;')}</div>
                                <div class="info-group"><i class="fas fa-phone"></i>${o.phoneNumber||'-'}</div>
                                <div class="info-group"><i class="fas fa-table"></i>Table ${o.tableNumber??'-'}</div>
                            </div>
                            <div class="order-items">
                                ${items}
                                <div class="order-total"><span>Total</span><span>₹${Number(o.totalAmount||0).toFixed(2)}</span></div>
                            </div>
                            ${o.status === 'pending' ? `<div style="margin-top:10px; display:flex; justify-content:flex-end;"><button class=\"btn\" onclick=\"completeOrder('${o._id}')\"><i class=\"fas fa-check\"></i> Complete Order</button></div>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }catch(e){ ordersGrid.innerHTML = `<div class="no-orders">${(e.message||'Error').replace(/</g,'&lt;')}</div>`; }
        }

        async function completeOrder(orderId){
            try{
                const res = await fetch(`${API_BASE_URL}/orders/${orderId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ status: 'completed' }) });
                if(!res.ok){ const data = await res.json().catch(()=>({})); throw new Error(data.error||'Failed to update'); }
                showToast('Order marked as completed', true);
                loadOrders();
            }catch(e){ showToast(e.message||'Failed to update'); }
        }

        document.getElementById('loginBtn').addEventListener('click', staffLogin);
        document.getElementById('refreshBtn').addEventListener('click', loadOrders);
        document.getElementById('logoutBtn').addEventListener('click', ()=>{ clearAuth(); updateView(); });

        // Init
        updateView();
    </script>
</body>
</html>


